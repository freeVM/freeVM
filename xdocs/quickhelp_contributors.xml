<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<document>

<properties>
	<title>Getting Started For Contributors</title>
	<author email="harmony-dev@incubator.apache.org">Harmony Documentation Team</author>
</properties>

<body>

	<section name="Getting Started For Contributors">
   
    <p>
      This document explains how to get configured to build and
      work with the Apache Harmony source code.
    </p>

    <subsection name="Prerequisites">

    <p>
    <i>Basic</i> prerequisites for working with Apache Harmony are:
    </p>
      
    <ul>
     <li>
      <a href="http://ant.apache.org/">Apache Ant</a> version 1.6.5 or later
     </li>
     <li>
      <a href="http://subversion.tigris.org/">Subversion</a>
     </li>
      <li>
        <a href="">Java SE 5 JDK</a>
      </li>
    </ul>
      
      <p>
        The other prerequisites for building Harmony differ by platform:
      </p>
      
      <strong>
        Windows
      </strong>
     
        <ul>
          <li>Microsoft 32-bit C/C++ Compiler, version 7 or higher</li>
          
          <li>Windows platform SDK</li>
          
          <li>
          <a href="http://www.intel.com/cd/software/products/asmo-na/eng/compilers/index.htm">
          Intel C++ Compiler</a>, version 9.0
          </li>
          <li>
          <a href="http://www.microsoft.com/products">Microsoft Visual Studio.NET 
          2003</a> or higher
          </li>
        </ul>
         
      <strong>
        Linux
      </strong>
      
        <ul>
          <li>gcc compiler</li>
          <li>g++ compiler</li>
          <li>make</li>
          <li>liblcms1-dev</li>
          <li>libpng12-dev</li>
          <li>libjpeg62-dev</li>
          <li>libx11-dev</li>
          <li>libxft-dev</li>
          <li>binutils-dev</li>
          <li>libxml2-dev</li>
        </ul>
        
      <p>
      For examples of platform-specific setup instructions, plese see these
      community maintained descriptions.
      </p>
      
      <p>
        <i>Additional</i> software and libraries that the building system 
        will download from the Internet are the following.  There is no need for 
        you to do this - this list is here for your reference.
      </p>
      <ul>
        <li>
          <a href="http://xml.apache.org/xalan-j/">Xalan-Java</a>, 
          version 2.7.0
        </li>
        <li>
          <a href="http://download.eclipse.org/eclipse/downloads/">Eclipse
          SDK</a>, version 3.1.1
        </li>
        <li>
          <a href="http://sourceforge.net/project/showfiles.php?group_id=36177">
          Cpp Tasks</a> collection, version 1.0 beta 3 or higher
        </li>
        <li>
          <a href="http://sourceforge.net/project/showfiles.php?group_id=36177">
          Ant-Contrib</a> collection of tasks, version 0.6 or higher
        </li>
        <li>
          <a href="http://www.zlib.net">Zlib</a> library, binaries, 
           version 1.2.1 or higher
        </li>
        <li>
          <a href="http://apr.apache.org/download.cgi">Apache Portable 
          Runtime</a>, version 1.2.6
        </li>
        <li>
          <a href="http://apr.apache.org/download.cgi">APR-util</a>, 
          version 1.2.6
        </li>
        <li>
          <a href="http://apr.apache.org/download.cgi">APR-iconv</a>, 
          version 1.1.1
        </li>
        <li>
          <a href="http://svn.apache.org/repos/asf/logging/log4cxx/trunk">
          Log4cxx</a>, latest log4cxx, SVN revision 365029
        </li>
      </ul>
      
      <p class="note">Note</p>
      <p class="notetext">
        The PATH environment variable must include the location of SVN tool set.
        Run SVN manually at least once prior to build, since it may ask to 
        accept the certificates from Apache site in an interactive manner.
      </p>

      <p>
        Alternatively, you can download these resources prior to building DRLVM,
        unpack these, and specify the resulting location by using the 
        environment variables, as described in the
        <a href="http://svn.apache.org/viewvc/incubator/harmony/enhanced/drlvm/trunk/README.txt?view=co">
        README file</a>, step 3.3.1. In this 
        <a href="http://svn.apache.org/viewvc/incubator/harmony/enhanced/drlvm/trunk/README.txt?view=co">
        README file</a> you can find instructions on how to point to local 
        versions instead of making the build download new ones from the net.
      </p>

    </subsection>

    <subsection name="Checking out the Federated Build Tree">

        <p>
          The Harmony codebase is divided into many separate parts. To create 
          a working JRE, you need a class library and a virtual machine. To 
          obtain these tools, use the <i>federated build</i> tree and then work
          within the class library directory and the VM directory as you choose.
          Currently, the federated build uses the DRLVM virtual machine.
        </p>

        <p>
            First, checkout the federated build:
        </p>

        <source>
 $ svn co https://svn.apache.org/repos/asf/incubator/harmony/enhanced/trunk
        </source>

        <p>
            The given command will checkout a directory structure that 
            contains <code>working_classlib</code> and <code>working_vm</code>
            directories. After the next step <code>working_classlib</code>
            will be the checkout of the class library SVN tree
            and <code>working_vm</code> will be the checkout
            of the DRLVM SVN tree.
        </p>

      <p class="note">Note</p>
      <p class="notetext">
        If you type <code>ant</code> in this directory, you will checkout, 
        build, and package snapshots of the JRE and HDK. However, this way 
        is inconvenient for a developer, so please continue with the next steps.
      </p>
    </subsection>

    <subsection name="Populating the VM and ClassLibrary Source Trees">
        <p>
            To help populate the source trees, use the target located
            in the federated build <code>build.xml</code> script. 
            Type the following command in the root directory of the 
            federated build:
        </p>

         <source>
$ ant populate_source
         </source>

        <p>
            The given command will checkout class library and DRLVM into the 
            <code>working_classlib</code> and <code>working_vm</code>
            directories respectively, at the same SVN version of the 
            <code>build.xml</code> file. The source trees are large, 
            therefore a checkout can take a very long time.</p>
      
            <p class="note">Note</p>
          <p class="notetext">
            If the root of the federated build is multiple levels deep in 
            your filesystem, the very long paths within class library might 
            result in a SVN checkout failure on Windows. The solution is to 
            move the tree upwards in your filesystem, or switch operating systems.
        </p>
        <p>
           Any time going forward, you can bring any directory to current SVN
           revision simply by doing <code>svn update</code> in any directory.
        </p>

        <source>
$ cd working_classlib
$ svn update
        </source>

        <p>
            The aforementioned commands are valid checkouts of the class library 
            and DRLVM. After executing <code>svn update</code>, your tree will 
            reflect any modifications made to the SVN repository. If you are a 
            project committer, you can make commits from within this tree, as it 
            is a normal SVN checkout.
        </p>

    </subsection>

    <subsection name="Building the Code">

        <p>
            Now you should be ready to build the code. First of all, you should
            build the class library, since the DRLVM has a dependency on the
            class library and also assembles a working JRE as part of its build. 
         </p>

        <strong>Building the Class Library</strong>
        <p>
            For the first time you build, you might want to fetch all the 
            class-library dependencies. If you do not, or if in the future a new
            dependency is added, the build will tell you what to do, so that you 
            can do this step periodically.
        </p>

        <source>
$ cd working_classlib
$ ant fetch-depends
$ ant
        </source>

      <p>
        If you are working from behind a firewall, you may need to configure
        <code>ant</code> to use a proxy via the <code>ANT_OPTS</code> 
        environment variable.</p>
      
      <p class="example">Example</p>
      <p class="notetext">
       
         <source>
<![CDATA[$ export ANT_OPTS='-Dhttp.proxyHost=<proxy.host> -Dhttp.proxyPort=<proxy port>']]>
        </source>
       
            If the aforementioned command succeeds, build the Apache Harmony 
            class library, the Java and the native code for your platform. 
            To run the test suite, you need a virtual machine. As the DRLVM is 
            yet incomplete, you can use the
            <a href="http://www.ibm.com/developerworks/java/jdk/harmony/index.html">
            IBM virtual machine for Harmony</a> generously made available for the project's
        development needs by IBM under a non-open source, binary evaluation license.
        To install the VM, follow the instructions that accompany that VM.
       You can expand the class library code over the top of the Harmony directory (so that the 'jdk'
          directories line-up)</p>
      <source>
unzip &lt;path_to_vm_zip&gt; -d ../.. (on Windows)
tar xzf &lt;path_to_vm_tarball&gt; --directory ../.. (on Linux)
      </source>
        
        

        <p>
            Once you have a VM installed, you can run the tests:
        </p>
        <source>
 $ ant test
        </source>

        <p>
            The given command will run the full testsuite for the class library.
        </p>

        <strong>Building DRLVM</strong>
        <p>
            When the class library is built, you should build the DRLVM 
            assembling a working JRE as well. To build the DRLVM, return 
            to the root of the federated build and switch into the
            <code>working_vm</code> directory. Then switch into DRLVM build
            directory.
        </p>

        <source>
 $ cd working_vm
 $ cd build
        </source>

        <p>
            First of all, tell the DRLVM build where to find the class library:
            rename the file <code>drlvm.properties.example</code> in the DRLVM
            <code>build</code> directory to <code>drlvm.properties</code>. 
            This file containes a property definition that tells DRLVM build to 
            use the class library in <code>working_classlib</code>. 
            If you want to point to another build of the class library, override 
            the given file on the command line.
        </p>

        <source>
 $ cp drlvm.properties.example drlvm.properties
        </source>

        <p class="note">Note</p>
      <p class="notetext">
        If you are a Windows user, you <i>must</i> work from the Visual
        Studio .NET Command Prompt installed with the Visual Studio.
        As for now, you cannot build from a Cygwin or other alternative shell. 
        Set the <code>CXX</code> environment variable to <code>msvc</code> 
        to indicate to the build used by the compiler:
      </p>

        <source>
 C:...\trunk\working_vm\build> set CXX=msvc
        </source>
     <p> You can switch between the different compilers and modes by using 
         the environment variables, as follows:
      </p>
     <p> <table width="100%">
        <tr>
          <th class="TableHeading">
            Compiler
          </th>
          <th class="TableHeading">
            On Windows
          </th>
          <th class="TableHeading">
            On Linux
          </th>
        </tr>
        <tr>
          <td class="TableCell">
            MSVC compiler
          </td>
          <td class="TableCell">
            set CXX=msvc
          </td>
          <td class="TableCell">
            N/A
          </td>
        </tr>
        <tr>
          <td class="TableCell">
            Intel(R) compiler
          </td>
          <td class="TableCell">
            set CXX=icl
          </td>
          <td class="TableCell">
            export CXX=icc
          </td>
        </tr>
        <tr>
          <td class="TableCell">
            GCC compiler
          </td>
          <td class="TableCell">
            N/A
          </td>
          <td class="TableCell">
            export CXX=gcc
          </td>
        </tr>
      </table></p>
        <p>
            Now you are ready to build. To start the build, fetch the 
            dependencies. Note that this can take a long time.
        </p>
        <source>
On Linux:
$ sh build.sh update

On Windows:
C:...\trunk\working_vm\build>build.bat update
        </source>

        <p>
            When you have obtained the dependencies, you can proceed 
            with the build:</p>
        
        <source>
On Linux:
$ sh build.sh

On Windows:
C:...\trunk\working_vm\build>build.bat
        </source>

        <p>
            To complete the operation, run the following tests:
        </p>
        <source>
On Linux:
$ sh build.sh test

On Windows:
C:...\trunk\working_vm\build>build.bat test
        </source>

        <p class="note">Note</p>
      <p class="notetext">The <code>kernel</code> tests do not currently pass. 
                          To succeed use <code>C Unit</code> and 
                          <code>Smoke</code> tests.
        </p>

        <p>
            At this point, the DRLVM build is complete. A full JRE is in the
            <code>deploy/jre</code> subdirectory of the <code>build</code> 
            directory.
                   </p>

        <source>
$ cd deploy/jre/bin
$ ./java -version
Apache Harmony Launcher : (c) Copyright 1991, 2006 The Apache Software Foundation or its licensors, as applicable.
java version "1.5.0"
pre-alpha : not complete or compatible
svn = r448280, (Sep 21 2006), Linux/ia32/gcc 3.4.6, debug build
http://harmony.apache.org/
        </source>

    </subsection>

    <subsection name="Using the Built Code">

        <p>
            Developers refer to one of the two ways of using code. Class 
            library developers install the IBM VME for Harmony in the 
            <code>working_classlib/deploy/jdk/jre</code>, so they can use 
            it as a well-known VM for unit testing. To work with the class 
            library, refer to the 
            <a href="subcomponents/classlibrary/index.html">classlibrary 
            subcomponent</a>. DRLVM developers work with the result of the 
            DRLVM build step, which is a JRE containing the DRLVM and the 
            class library. To work with the DRLVM, set 
            <code>JAVA_HOME</code> to the <code>deploy/jre</code>.
        </p>
    </subsection>

    <subsection name="Running Java Applications">
    
      <p>
        Ensure that the <code>JAVA_HOME</code> environment variable is unset, or pointing
        to the <code>Harmony/deploy/jdk/jre</code> directory.
      </p>
      <p>
        Run Java applications as usual, using the launcher in Harmony/deploy/jdk/jre/bin:</p>
        <source>
> jre\bin\java -showversion -jar helloworld.jar
java version 1.5 (subset)
(c) Copyright 1991, 2006 The Apache Software Foundation or its licensors, as applicable.
Hello world!
        </source>
     
    </subsection>
    </section>
</body>

</document>
        
