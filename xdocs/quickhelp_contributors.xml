<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<document>

<properties>
    <title>Getting Started For Contributors</title>
    <author email="dev@harmony.apache.org">Harmony Documentation Team</author>
</properties>

<body>

  <section name="Getting Started For Contributors">
    <p>
      This document explains how to get configured to build and
      work with the Apache Harmony source code. The build is evolving.
      If you come across a problem, double-check the
      <a href="mailing.html">mailing list</a>:
      your issue may have been already discovered and resolved.
    </p>
    <subsection name="Prerequisites">
      <p>
        <strong>Basic Prerequisites</strong>
      </p>
      <p>The tools you must have to be able to work with Harmony are:</p>

      <ul>
        <li>
          <a href="http://ant.apache.org/">Apache Ant</a> version 1.6.5 or later
        </li>
        <li>
          <a href="http://subversion.tigris.org/">Subversion</a>
        </li>
        <li>
          <a href="">Java SE 5 JDK</a>
        </li>
      </ul>
      <p class="note">Note</p>
      <p class="notetext">
        If you are working from behind a firewall, you may need to configure
        the proxy setting for <code>ant</code> and <code>svn</code> tools.<br />
        For the <code>ant</code> tool, set the <code>ANT_OPTS</code> environment
        variable to point to: <code>
          <br />
          -Dhttp.proxyHost=&lt;host&gt;<br />
          -Dhttp.proxyPort=&lt;proxy&gt;
        </code><br />
        For the <code>svn</code> tool, follow the instructions appropriate to
        the version of the tool you use. For example, edit <code>~/.subversion/servers</code>
        file for console version of <code>svn</code>.
      </p>
      <p>
        The other prerequisites for building Harmony differ by platform. For
        examples of platform-specific setup instructions, please see these
        <a href="http://wiki.apache.org/harmony/DevelopmentPlatformConfiguration">community maintained</a>
        descriptions. Below is a generic guideline for each platform. <br />
        To learn which platforms are currently supported, see the
        <a href="roadmap.html#Porting Matrix">Porting Matrix</a>.
      </p>
      <table>
        <tr>
          <th class="TableHeading">
            On Windows
          </th>
          <th class="TableHeading">
            On Linux
          </th>
        </tr>
        <tr>
          <td class="TableCell">
            <ul>
              <li>Microsoft 32-bit C/C++ Compiler, version 7 or higher</li>
              <li>Windows platform SDK</li>
              <li>
                <a href="http://www.intel.com/cd/software/products/asmo-na/eng/compilers/index.htm">
                  Intel C++ Compiler
                </a>, version 9.0
              </li>
              <li>
                <a href="http://www.microsoft.com/products">
                  Microsoft Visual Studio.NET
                  2003
                </a>
              </li>
            </ul>
          </td>
          <td class="TableCell">
            <ul>
              <li>
                gcc compiler, version 3.3.3 or higher<br />
                Versions below 3.3.3 have not been tested but might work.
              </li>
              <li>g++ compiler</li>
              <li>make</li>
              <li>liblcms1-dev</li>
              <li>libpng12-dev</li>
              <li>libjpeg62-dev</li>
              <li>libx11-dev</li>
              <li>libxft-dev</li>
              <li>binutils-dev</li>
              <li>libxml2-dev</li>
            </ul>
          </td>
        </tr>
      </table>
      <p>
        <strong>Additional Prerequisites</strong>
      </p>
      <p>
        The build system requires additional software and libraries shared
        across different parts of the build or specific for individual build parts.
        The list is evolving, so the safest way to get and configure all the required software
        is to let the build download it from the Internet.
      </p>
      <p>
        Here is the list of additional tools required for one of the build parts, DRLVM.
        The list applies to Windows and Linux users.
      </p>
      <ul>
        <li>
          <a href="http://xml.apache.org/xalan-j/">Xalan-Java</a>,
          version 2.7.0 (taken from class libraries component)
        </li>
        <li>
          <a href="http://sourceforge.net/project/showfiles.php?group_id=36177">
            Cpp Tasks
          </a> collection, version 1.0 beta 3 or higher (downloaded)
        </li>
        <li>
          <a href="http://sourceforge.net/project/showfiles.php?group_id=36177">
            Ant-Contrib
          </a> collection of tasks, version 0.6 or higher (downloaded)
        </li>
        <li>
          <a href="http://www.zlib.net">Zlib</a> library, binaries,
          version 1.2.1 or higher (downloaded)
        </li>
        <li>
          <a href="http://apr.apache.org/download.cgi">
            Apache Portable
            Runtime Layer
          </a>, version 1.2.6 (downloaded)
        </li>
        <li>
          <a href="http://apr.apache.org/download.cgi">APR-util</a>,
          version 1.2.6 (downloaded)
        </li>
        <li>
          <a href="http://apr.apache.org/download.cgi">APR-iconv</a>,
          version 1.1.1 (downloaded)
        </li>
        <li>
          <a href="http://svn.apache.org/repos/asf/logging/log4cxx/trunk">
            Log4cxx
          </a>, latest log4cxx, SVN revision 467164 (downloaded)
        </li>
      </ul>
      <p>
        You can download these resources prior to building DRLVM,
        unpack them, and specify the resulting locations by using the environment variables,
        as described in the
        <a href="http://svn.apache.org/viewvc/harmony/enhanced/drlvm/trunk/README.txt?view=co">
          README file
        </a>, step 3.3.1. In this file, you can find instructions
        on how to point to local versions instead of making the build download new ones from the net.
        <br /> Because the list of sotware is subject to change, we do <b>not</b> recommend
        that you download the software and not let the
        build do that for you.
      </p>
    </subsection>
  </section>
  <section name="Getting the Source Code">
    <subsection name="Checking out the Federated Build Tree">
        <p>
          The Harmony codebase is divided into many separate parts. To create
          a working JRE, you need a <i>class library</i> and a <i>virtual machine</i>. To
          obtain these tools, use the <i>federated build</i> tree and then work
          within the class library directory and the VM directory as you choose.
          Currently, the federated build uses the DRLVM virtual machine.
        </p>

        <p>
          To check out the federated build, use the following command:
        </p>

        <source>
$ svn co https://svn.apache.org/repos/asf/harmony/enhanced/trunk</source>

        <p>
          The given command checks out a directory structure that
          contains <code>working_classlib</code> and <code>working_vm</code>
          directories. After you populate the source trees in the next step,
          <code>working_classlib</code>
          will be the checkout of the class library SVN tree
          and <code>working_vm</code> will be the checkout
          of the DRLVM SVN tree.
        </p>
        <p class="note">Note</p>
        <p class="notetext">
          If the root of the federated build is multiple levels deep in
          your file system, the very long paths within class library might
          result in a SVN checkout failure on Windows. The solution is to
          move the tree upwards in your file system or switch operating systems.
        </p>
        <p>
          If you type <code>ant</code> in the root directory of federated build,
          you will checkout, build, and package snapshots of the JRE and HDK.
          However, this way is inconvenient for a developer, so please continue
          with the next steps.
        </p>
      </subsection>
    <subsection name="Populating the VM and ClassLibrary Source Trees">
        <p>
          To populate the source trees, use the target located
          in the federated build <code>build.xml</code> script.
          Type the following command in the root directory of the
          federated build:
        </p>
        <source>$ ant populate_source</source>
        <p>
          The given command checks out class library and DRLVM into the
          <code>working_classlib</code> and <code>working_vm</code>
          directories respectively, <i>
            at the same SVN version of
            the <code>build.xml</code> file
          </i>.
          The source trees are large,
          therefore a checkout can take a very long time.
        </p>
      </subsection>
    <subsection name="Updating the VM and ClassLibrary Source Trees">
        <p>
          Any time going forward, you can bring any directory to current SVN
          revision simply by doing <code>svn update</code> in any directory.
        </p>

        <source>
$ cd working_classlib
$ svn update</source>

        <p>
          The aforementioned commands are valid checkouts of the class library
          and DRLVM. After executing <code>svn update</code>, your tree will
          reflect any modifications made to the SVN repository. If you are a
          project committer, you can make commits from within this tree, as it
          is a normal SVN checkout.
        </p>
        <p class="note">Note</p>
        <p class="notetext">
          If you fail to rebuild class library after the <code>svn update</code> command,
          clean previous build results:
        </p>
        <source>$ ant clean</source>

      </subsection>
    </section>
  <section name="Building the Code">
        <p>
          Now you should be ready to build the code. First build
          the class library because DRLVM has a dependency on it and also
          assembles a working JRE as part of its build.
        </p>
    <subsection name="Building the Class Library">
        <p>
          For the first time you build, you might want to fetch all the
          class library dependencies. If you do not, or if in the future a new
          dependency is added, the build will tell you what to do, so that you
          can do this step periodically. To fetch the class library dependencies
          and then build class library, use the following commands:
        </p>
        <source>
$ cd working_classlib
$ ant fetch-depends
$ ant</source>
        <p>
          You can only test the class libraries in case you have a virtual machine.
          If you do, run the following command to get the full test suite for the class library:
        </p>
        <source>$ ant test</source>
        <p>
          You can use a VM other than DRLVM, see
          <a href="#Combining JRE from Built Components">Combining JRE from Built Components</a>.
          If you want to
          use DRLVM, proceed with the instruction to build it.
        </p>
      </subsection>
    <subsection name="Building DRLVM">
        <ol>
          <li>
            <b>Enter the build directory.</b><br />
            After building the class library, build DRLVM
            assembling a working JRE. For that, return
            to the root of the federated build and switch into the
            <code>working_vm</code> directory, then to the <code>build</code>
            directory:
            <pre>
$ cd working_vm/build</pre>
          </li>
          <li>
            <b>Configure the environment.</b>
            <ul>
              <li>
                Edit <code>drlvm.properties</code>
                <p>
                  Tell the DRLVM build where to find the class library:
                  rename the file <code>drlvm.properties.example</code> in the DRLVM
                  <code>build</code> directory to <code>drlvm.properties</code>.
                </p>
                <pre>$ cp drlvm.properties.example drlvm.properties</pre>
                <p>
                This file contains a property definition that tells DRLVM build to
                use the class library in <code>working_classlib</code>.
                  If you want to point to another build of the class library, override
                  the given file on the command line.
                </p>
                <p>
                Double-check that the resulting properties file has
                <code>deploy.canonical.flag</code> set to <code>TRUE</code>. This value
                enables the build to create the
                <code>deploy/jre/bin</code> directory. Further building procedures require
                this directory.</p>
              </li>
              <li>
                Select the compiler.
                <p>
                You can switch between the different compilers and modes by using
                the environment variables, as follows:
              </p>
                <table>
                  <tr>
                    <th class="TableHeading">
                      Compiler
                    </th>
                    <th class="TableHeading">
                      On Windows
                    </th>
                    <th class="TableHeading">
                      On Linux
                    </th>
                  </tr>
                  <tr>
                    <td class="TableCell">
                      MSVC compiler
                    </td>
                    <td class="TableCell">
                      set CXX=msvc
                    </td>
                    <td class="TableCell">
                      N/A
                    </td>
                  </tr>
                  <tr>
                    <td class="TableCell">
                      Intel(R) compiler
                    </td>
                    <td class="TableCell">
                      set CXX=icl
                    </td>
                    <td class="TableCell">
                      export CXX=icc
                    </td>
                  </tr>
                  <tr>
                    <td class="TableCell">
                      GCC compiler
                    </td>
                    <td class="TableCell">
                      N/A
                    </td>
                    <td class="TableCell">
                      export CXX=gcc
                    </td>
                  </tr>
                </table>
              </li>
              <li>
                Select the working mode: debug or release.
                <p>
              By default, the debug configuration is used. To switch to
              the release mode, do:
              </p>
              <pre>
On Windows:
> set BUILD_CFG=release
> build.bat

On Linux:
$ BUILD_CFG=release ./build.bat
</pre>
              </li>
            </ul>
          </li>
          <li>
            <b>Fetch the dependencies.</b><br />
            Before starting the build, fetch the
            dependencies. Note that this can take a long time.
            <pre>
On Windows:
C:...\trunk\working_vm\build>build.bat update

On Linux:
$ sh build.sh update</pre>
          </li>
          <li>
            <b>Build the code.</b><br />
            To proceed with the build, run the following:
            <pre>
On Windows:
C:...\trunk\working_vm\build>build.bat

On Linux:
$ sh build.sh</pre>
          </li>
          <li>
            <b>Run the acceptance tests.</b><br />
            To complete the operation, run the following acceptance tests:
            <pre>
On Windows:
C:...\trunk\working_vm\build>build.bat test

On Linux:
$ sh build.sh test</pre>

            <p class="note">Note</p>
            <p class="notetext">
              The <code>kernel</code> tests do not currently pass.
              To succeed, use <code>C Unit</code> and
              <code>Smoke</code> tests.
            </p>
          </li>
        </ol>
        <p>
          At this point, the DRLVM build is complete. A full JRE is in the
          <code>deploy/jre</code> subdirectory of the <code>build</code>
          directory.
        </p>
        <p>
          For example, you can run JRE with the <code>-version</code> argument
          to see its version:
        </p>

        <pre>
$ cd deploy/jre/bin
$ ./java version
Apache Harmony Launcher:
(c) Copyright 1991, 2006 The Apache Software Foundation or its licensors, as applicable.
java version "1.5.0"
pre-alpha : not complete or compatible
svn = r479551, (Nov 27 2006), Windows/ia32/msvc 1310, debug build
http://harmony.apache.org</pre>
      </subsection>
    <subsection name="Combining JRE from Built Components">
        <p>
          <b>Class library developers</b> can work with DRLVM or install
          another compatible VM. For example, you can use the
          <a href="http://www.ibm.com/developerworks/java/jdk/harmony/index.html">
            IBM virtual machine
          </a> that has been generously made available for the project's
          development needs by IBM under a non-open source, binary evaluation license.
          To install the VM, follow the instructions that accompany that VM.
          You can expand the class library code over the top of the Harmony directory (so that the 'jdk'
          directories line-up)
        </p>
        <source>
On Windows:
$ unzip &lt;path_to_vm_zip&gt; -d ../..

On Linux:
$ tar xzf &lt;path_to_vm_tarball&gt; --directory ../..</source>
        <p>
          To work with the Harmony class library, refer to the
          <a href="subcomponents/classlibrary/index.html">
            class library subcomponent
          </a>.
        </p>
        <p>
          <b>DRLVM developers</b> work with the result of the
          DRLVM build step, which is a JRE containing DRLVM and the
          class library.
        </p>
      </subsection>
    </section>
  <section name="Running Java Applications">
      <p>
        Ensure that the <code>JAVA_HOME</code> environment variable is unset, or pointing
        to the <code>deploy/jre</code> directory.
      </p>
      <p>
        Run Java applications normally using the launcher in
        <code>deploy/jre/bin</code>:
      </p>
      <source>
$ deploy/jre/bin/java -showversion -jar helloworld.jar
Apache Harmony Launcher:
(c) Copyright 1991, 2006 The Apache Software Foundation or its licensors, as applicable.
java version "1.5.0"
pre-alpha : not complete or compatible
svn = r479551, (Nov 27 2006), Windows/ia32/msvc 1310, debug build
http://harmony.apache.org
Hello world!</source>
    </section>
</body>

</document>
