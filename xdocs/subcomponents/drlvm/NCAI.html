<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements. See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type"
      content="text/html; charset=UTF-8" />
      <link href="../../css/site.css" rel="stylesheet" type="text/css" />
      <title>
         Native Code Access Interface
      </title>
   </head>
   <body>
      <h1>
         <a id="top" name="top"></a>Native Code Access Interface
      </h1>
      <ol id="TOC">
        <li><a href="#About">About This Document</a></li>
        <li><a href="#Overview">Overview</a>
        <li><a href="#Key_Feature">Key Features</a></li>
        <li><a href="#NCAI_in_VM">NCAI in VM</a></li>
        <li><a href="#Issues">Known issues</a></li>
        <li><a href="#References">References</a></li>
       </ol>

<!-- 1st chapter: About This Document -->
      <h1>
         <a id="About" name="About"></a>About This Document
      </h1>
      <p>
         This document introduces the Native Code Access Interface and
         its implementation inside the DRL virtual machine.
      </p>

<!-- 2nd chapter: Overview -->
      <h1>
         <a id="Overview" name="Overview"></a>Overview
      </h1>
      <p>
        Some Java<a href="#*">*</a> applications need to access native code via the
        Java<a href="#*">*</a> Native Interface (JNI) [<a href="#JNI_ref">1</a>]
        to access native code.
        Common Java<a href="#*">*</a> debuggers, such as Eclipse<a href="#*">*</a>
        and NetBeans<a href="#*">*</a> debuggers, do not fully support debugging
        native code written in programming languages like C/C++.
        Some techniques, like the CDT plugin for Eclipse<a href="#*">*</a>,
        are used for debugging native code in Java<a href="#*">*</a>
        applications, but all of them have their own limitations.
      </p>
      <p>
        Native Code Access Interface (NCAI) is a different approach to
        debugging JNI code in Java<a href="#*">*</a> applications.
        Together with JVMTI [<a href="#JVMTI_ref">2</a>] it provides in-process debugging
        of both JIT-compiled and interpreted Java<a href="#*">*</a> bytecode,
        and native JNI code.
      </p>
      <p>
        NCAI interface is a JVMTI-like interface exposed by DRLVM
        through a JVMTI extension. See detailed <a href="NCAI_spec.html">
        NCAI description</a> for interface details.
      </p>
      <p>
        The Eclipse<a href="#*">*</a>
        <a href="http://softwarecommunity.intel.com/articles/eng/1435.htm">
        plugin utilizing NCAI interface</a> is available at
        Intel<a href="#*">*</a> What If site [<a href="#whatif_ref">3</a>].
        This plugin supports Java<a href="#*">*</a> and C/C++, and builds
        into Eclipse<a href="#*">*</a> IDE re-using JDT and CDT debug views.
      </p>
      <p>
        Examples of NCAI usage can be found in NCAI tests sources:
        <a href="http://svn.apache.org/viewvc/harmony/enhanced/drlvm/trunk/vm/tests/ncai/">
        drlvm/trunk/vm/tests/ncai</a>.
      </p>

      <p class="backtotop">
         <a href="#top">Back to Top</a>
      </p>

<!-- 3rd chapter: Key Features -->
      <h1>
         <a id="Key_Feature" name="Key_Feature"></a>Key Features
      </h1>
      <p>
        The current NCAI implementation supports x86 architecture;
        some features are available on x86_64.
      </p>
      <p>
        Main NCAI features implemented for now:
      </p>
      <ul>
        <li>
           Setting breakpoints in native code
        </li>
        <li>
           Single-stepping through native code with 3 step modes:
           <code>STEP_INTO</code>, <code>STEP_OVER</code> and <code>STEP_OUT</code>
        </li>
        <li>
           Trapping native signals and exceptions
        </li>
        <li>
           Trapping loading and unloading of native modules
        </li>
        <li>
           Getting information on loaded native modules
        </li>
        <li>
           Getting the list of threads running in a VM process
        </li>
        <li>
           OS-level thread operations: suspend, resume, terminate
        </li>
        <li>
           Inspection and modification of processor registers for
           suspended threads
        </li>
        <li>
           Getting the call stack with Java<a href="#*">*</a>
           and native frames
        </li>
        <li>
           Native memory inspection and modification
        </li>
        <li>
           Getting information on native signals and exceptions
        </li>
      </ul>

      <p class="backtotop">
         <a href="#top">Back to Top</a>
      </p>

<!-- 4th chapter: NCAI in VM -->
      <h1>
         <a id="NCAI_in_VM" name="NCAI_in_VM"></a>NCAI in VM
      </h1>
      <p>
         NCAI is implemented as a part of DRLVM. The source code is generally
         located in the <a
         href="http://svn.apache.org/viewvc/harmony/enhanced/drlvm/trunk/vm/vmcore/src/ncai/">
         drlvm/trunk/vm/vmcore/src/ncai</a> directory,
         with platform-dependent code in
         <a href="http://svn.apache.org/viewvc/harmony/enhanced/drlvm/trunk/vm/vmcore/src/ncai/utils/">
         'utils'</a> subdirectory.
      </p>
      <p>
         In addition to standalone code, NCAI includes code and changes
         in other parts of DRLVM, specifically:
      </p>
      <ul>
        <li>
          In the VM Core subcomponent, NCAI extends JVMTI functionality,
          signal handling and breakpoints processing.
        </li>
        <li>
          <a href="TM.html">Thread Manager</a> contains thread operations
          needed for NCAI operation.
        </li>
        <li>
          The Porting Layer contains native modules enumeration
          and memory access functions for NCAI needs (both are also used now
          by <a href="crash_handler.html">Crash Handler</a>), and OS-level
          thread operations including suspending and resuming of threads.
          NOTE: On Linux* OS, the <code>SIGUSR2</code> signal is shared between
          NCAI threading and <code>port_thread_yield_other()</code> function
          implementation.
        </li>
        <li>
          The encoder has been extended to enable the decoder to disassemble
          native code; this functionality is used by NCAI single stepping
          and by the <a href="crash_handler.html">Crash Handler</a>.
        </li>
      </ul>

      <p class="backtotop">
         <a href="#top">Back to Top</a>
      </p>

<!-- 5th chapter: NCAI in VM -->
      <h1>
         <a id="Issues" name="Issues"></a>Known issues
      </h1>
      <p>
         Known issues and limitations in the current NCAI implementation include:
      </p>
      <ul>
        <li>
          Only threads attached to VM are reported.
        </li>
        <li>
          The ModuleLoad and ModuleUnload events are reported only for JNI libraries.
        </li>
        <li>
          The TerminateThread() function does not affect Java<a href="#*">*</a>
          thread status.
        </li>
        <li>
          The GetStackTrace() function works fine for debug build only.
          On release build of either DRLVM or debugged library,
          the function can return partial stack trace.
        </li>
        <li>
          The thread context obtained in during Breakpoint and Single Step processing
          is not synchronized with the thread context stored during thread suspension.
        </li>
      </ul>

      <p class="backtotop">
         <a href="#top">Back to Top</a>
      </p>

<!-- 6th chapter: References -->
      <h1>
         <a id="References" name="References"></a>References
      </h1>
      <p>
         This section lists the resources used in this document and other
         related documents.
      </p>
      <p>
         [<a id="JNI_ref" name="JNI_ref"></a>1] Java<a href="#*">*</a> Native
         Interface Specification, <a
         href="http://java.sun.com/j2se/1.5.0/docs/guide/jni/spec/jniTOC.html"
         target="_blank">http://java.sun.com/j2se/1.5.0/docs/guide/jni/spec/jniTOC.html</a>
      </p>
      <p>
         [<a id="JVMTI_ref" name="JVMTI_ref"></a>2] JVM Tool Interface
         Specification, <a
         href="http://java.sun.com/j2se/1.5.0/docs/guide/jvmti/jvmti.html"
         target="_blank">http://java.sun.com/j2se/1.5.0/docs/guide/jvmti/jvmti.html</a>
      </p>
      <p>
         [<a id="whatif_ref" name="whatif_ref"></a>3] Intel<a href="#*">*</a> What If site, <a
         href="http://whatif.intel.com"
         target="_blank">http://whatif.intel.com</a>
      </p>
      
      <p class="backtotop">
         <a href="#top">Back to Top</a>
      </p>
     
      <p>
         <a id="*" name="*"></a>* Other brands and names are the property of
         their respective owners.
      </p>
   </body>
</html>
