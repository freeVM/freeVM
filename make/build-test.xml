<?xml version="1.0" encoding="UTF-8"?>

<!-- Copyright 2005 The Apache Software Foundation or its licensors, as applicable

     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

         http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<project name="classlib-test" default="test-all" basedir="..">

    <description> Tests for classlib package</description>

    <!-- import common properties -->
    <import file="${basedir}/make/properties.xml" />

    <!-- set global properties for this build. -->

    <property name="build.compiler" value="modern"/>

    <property name="tests.output" location="build/test_report" />
	<property name="hy.hdk" location="deploy" />
    <property name="hy.jdk" location="${hy.hdk}/jdk" />

    <property name="tests.build.output" location="build/tests" />
    <property name="support.dir" location="support"/>
    <property name="tests.depends.jars" location="deploy/jdk/jre/lib/boot" />
    <property file="make/depends.properties" />

	<!-- this list of components to test will grow to eventually be all modules -->
	<target name="test-all"
		depends="clean, test-annotation, test-archive, test-auth, test-beans, test-crypto, test-jndi, test-logging, test-luni, test-math, test-nio, test-nio_char, test-prefs, test-regex, test-rmi, test-security, test-sql, test-text, test-xnet, gen-report, check-test-result">
	</target>

	<target name="clean">
		<delete dir="${tests.output}" />
	</target>

	<target name="test-annotation" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module annotation"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/annotation" target="test" />

	</target>

	<target name="test-luni" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module luni"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/luni" target="test"/>
	</target>

	<target name="test-archive" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module archive"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/archive" target="test" />

	</target>

	<target name="test-xnet" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module x-net"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/x-net" target="test" />

	</target>

	<target name="test-crypto" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module crypto"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/crypto" target="test" />

	</target>

	<target name="test-auth" depends="compile-support">
		<echo message="=================================="/>
		<echo message="Running tests for module auth"/>
		<echo message="=================================="/>

		<ant antfile="make/build.xml" dir="modules/auth" target="test" />

	</target>

	<target name="test-text" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module text"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/text" target="test" />

	</target>

	<target name="test-nio" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module nio"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/nio" target="test" />

	</target>

	<target name="test-nio_char" depends="compile-support">
        <echo message="=================================="/>
        <echo message="Running tests for module nio_char"/>
        <echo message="=================================="/>

        <ant antfile="make/build.xml" dir="modules/nio_char" target="test" />

	</target>

	<target name="test-jndi" depends="compile-support">
            <echo message="=================================="/>
            <echo message="Running tests for module jndi"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/jndi" target="test" />
	</target>

	<target name="test-logging" depends="compile-support">
            <echo message="=================================="/>
            <echo message="Running tests for module logging"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/logging" target="test" />
	</target>

	<target name="test-prefs" depends="compile-support">
            <echo message="=================================="/>
            <echo message="Running tests for module prefs"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/prefs" target="test" />
	</target>

	<target name="test-sql" depends="compile-support">
            <echo message="=================================="/>
            <echo message="Running tests for module sql"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/sql" target="test" />
	</target>

	<target name="test-beans" depends="compile-support">
            <echo message="=================================="/>
            <echo message="Running tests for module beans"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/beans" target="test" />
	</target>

	<target name="test-math">
            <echo message="=================================="/>
            <echo message="Running tests for module math"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/math" target="test" />
	</target>

	<target name="test-regex">
            <echo message="=================================="/>
            <echo message="Running tests for module regex"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/regex" target="test" />
	</target>

	<target name="test-rmi">
            <echo message="=================================="/>
            <echo message="Running tests for module rmi"/>
            <echo message="=================================="/>
            <ant antfile="make/build.xml" dir="modules/${hy.rmi.module}" target="test" />
	</target>

	<target name="test-security" depends="compile-support">
	
            <echo message="=================================="/>
            <echo message="Running tests for module security"/>
            <echo message="=================================="/>

            <ant antfile="make/build.xml" dir="modules/security" target="test"/>
	</target>

	<target name="gen-report">
		<junitreport todir="${tests.output}">
		  <fileset dir="${tests.output}">
		    <include name="TEST*-*.xml"/>
		  </fileset>
		  <report format="frames" todir="${tests.output}/html"/>
		</junitreport>

		<!-- use this property just to get the slashes to display right in the echo -->
		<property name="display-location" location="${tests.output}/html/index.html"/>
		<echo message="The test report is in ${display-location}"/>
    </target>

    <target name="compile-support" depends="copy-test-resources, check-support-jars"
    	description="Compile the unit test source">
    	<mkdir dir="${tests.build.output}" />
    	<javac destdir="${tests.build.output}"
    		source="${hy.javac.source}"
    		target="${hy.javac.target}"
    		debug="on">

            <src path="${support.dir}/src/test/java" />
            <classpath location="${junit.jar}" />
            <classpath location="${tests.build.output}" />
            <bootclasspath>
                <fileset dir="${tests.depends.jars}">
                    <include name="**/*.jar" />
                </fileset>
            </bootclasspath>
        </javac>
    	
    </target>
	
    <target name="check-test-result">
        <available property="test.errors"
            file="${tests.output}/test.errors" />
        <available property="test.failures"
            file="${tests.output}/test.failures" />
        <fail if="test.errors" message="There were test errors." />
        <fail if="test.failures" message="There were test failures." />
    </target>

    <!-- ================================= 
          target: copy-test-resources              
         ================================= -->
    <target name="copy-test-resources"
       description="Copy non-Java files from unit test trees to the bin output">
        <mkdir dir="${tests.build.output}" />

        <copy todir="${tests.build.output}" includeemptydirs="false">
            <fileset dir="${support.dir}/src/test/java">
                <exclude name="**/*.java" />
            </fileset>
            <fileset dir="modules/archive/src/test/java">
                <exclude name="**/*.java" />
            </fileset>
            <fileset dir="modules/luni/src/test/java">
                <exclude name="**/*.java" />
            </fileset>
            <fileset dir="modules/nio_char/src/test/java">
                <exclude name="**/*.java" />
            </fileset>
            <fileset dir="modules/text/src/test/java">
                <exclude name="**/*.java" />
            </fileset>
        </copy>
    </target>

    <target name="check-support-jars"
    	    description="Check for jars required to compile and run unit tests">

      <ant antfile="make/depends.xml" inheritall="false" target="check"/>

    </target>

    <target name="run-tests" description="Run JUnit tests">
    	<!-- The location of the Harmony launcher can be overridden by 
    	     the "harmony.vm.exe" property. Default value of property
    	     is set assuming it is under the deploy tree -->
    	<property name="harmony.vm.exe" location="${hy.jdk}/jre/bin/java"/>
    	
        <!-- Delete "junitCompleted" - an empty file that can be used to
             check that the junit test VM does not exit prematurely -->
        <delete file="${user.home}/junitCompleted" failonerror="false" />

        <path id="classpath.id" location="${tests.build.output}" />
    	
    	<java classname="tests.main.AllTests"
    		fork="true"
    		jvm="${harmony.vm.exe}">
    		
            <jvmarg value="-showversion" />

            <!-- Required by various tests that set security manager etc -->
            <jvmarg value="-Djava.security.policy=${support.dir}/src/test/resources/config/testing.policy" />

            <!-- Required for running the java.net unit tests -->
            <jvmarg value="-Dtest.ini.file=${support.dir}/src/test/resources/config/localhosttest.ini" />

            <!-- Required if using the test excluder decorator -->
            <jvmarg value="-Dexcludes.file.uri=file:///${support.dir}/src/test/resources/config/jcltest-excludes.xml" />
        	
            <classpath>
                <path refid="classpath.id" />
                <pathelement location="${junit.jar}" />
            </classpath>
   		</java>
    </target>

	
    <!-- ================================= 
          target: run-tests-with-junit-task
         ================================= -->
    <target name="run-tests-with-junit-task" description="Run JUnit tests">
    	<!-- The location of the Harmony launcher can be overridden by 
    	     the "harmony.vm.exe" property. Default value of property
    	     is set assuming it is under the deploy tree -->
    	<property name="harmony.vm.exe" location="${hy.jdk}/jre/bin/java"/>

        <!-- Delete "junitCompleted" - an empty file that can be used to
             check that the junit test VM does not exit prematurely -->
        <delete file="${user.home}/junitCompleted" failonerror="false" />

        <path id="classpath.id" location="${tests.build.output}" />
    	
        <junit fork="true"
               forkmode="once"
               jvm="${harmony.vm.exe}"
               errorproperty="tests.failed"
               failureproperty="tests.failed">
            <env key="JAVA_HOME" value="${hy.jdk}/jre" />
            <env key="LD_LIBRARY_PATH" value="" />
            <!-- required to be unset on Linux -->
            
            <jvmarg value="-showversion" />

            <!-- Required by various tests that set security manager etc -->
            <jvmarg value="-Djava.security.policy=${support.dir}/src/test/resources/config/testing.policy" />

            <!-- Required for running the java.net unit tests -->
            <jvmarg value="-Dtest.ini.file=${support.dir}/src/test/resources/config/localhosttest.ini" />

            <!-- Required if using the test excluder decorator -->
            <jvmarg value="-Dexcludes.file.uri=file:///${support.dir}/src/test/resources/config/jcltest-excludes.xml" />
        	
            <classpath>
                <path refid="classpath.id" />
                <pathelement location="${junit.jar}" />
            </classpath>
        	
            <formatter type="plain" usefile="false" />
            <formatter type="xml" />
        	
        	<test todir="${tests.results.dir}" name="tests.main.AllTests" />
        </junit>

        <fail if="tests.failed" message="Some Tests Failed !" />

        <!-- if the junit test process completed as expected, this file
             should now exist -->
        <fail message="JUnit task ended prematurely - Hint: This may have been caused by the test VM terminating unexpectedly during the test run">
            <condition>
                <not>
                    <available file="${user.home}/junitCompleted" />
                </not>
            </condition>
        </fail>
        <!-- Clean up after ourselves -->
        <delete file="${user.home}/junitCompleted" />
    </target>

</project>
