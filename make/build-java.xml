<?xml version="1.0" encoding="UTF-8"?>

<!-- Copyright 1998, 2005 The Apache Software Foundation or its licensors, as applicable
     
     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at
     
         http://www.apache.org/licenses/LICENSE-2.0
     
     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License. -->

<!-- ====================================================================== 
     build-java-source    
     Compile the Java source and package in component archives.
     ====================================================================== -->
<project name="build-java-source" default="default" basedir="..">
    <description>
		Compile the Java source and package in component archives.
    </description>

    <!-- import common properties -->
    <import file="${basedir}/make/properties.xml" />

    <!-- Users need to set this property to use a different compiler -->
    <!-- To use the eclipse compiler set the value of the below      -->
    <!-- property to be "org.eclipse.jdt.core.JDTCompilerAdapter"    -->
    <!-- This requires that the CLASSPATH of the environment where   -->
    <!-- this Ant is running includes the Eclipse archives           -->
    <!-- jdtCompilerAdapter.jar and org.eclipse.jdt.core_3.1.0.jar   -->
    <property name="build.compiler" value="modern" />

    <property name="build.output" location="build/classes" />
    <property name="depends.jars" location="depends/jars" />
    <property name="depends.manifests" location="depends/manifests" />
    <property name="depends.files" location="depends/files" />
	<property name="hy.hdk" location="deploy" />
    <property name="hy.jdk" location="${hy.hdk}/jdk" />
    <property file="make/depends.properties" />


    <!-- ================================= 
          target: default              
         ================================= -->
    <target name="default" 
        description="Compile the Java source and package in component archives." 
        depends="clean, build" />

    <!-- ================================= 
          target: build
         ================================= -->
    <target name="build" depends="compile, layout" />

    <!-- ================================= 
          target: clean            
         ================================= -->
    <target name="clean" depends="clean-bin, clean-layout" />


    <!-- ================================= 
          target: clean-bin              
         ================================= -->
    <target name="clean-bin" description="Delete all built classes">
        <call-modules target="clean" />
        <antcall target="clean-kernel-patternsets" />
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${build.output}">
                <include name="**/**" />
            </fileset>
        </delete>
    </target>

    <target name="copy-kernel-patternsets">
        <mkdir dir="${hy.hdk}/build/patternsets" />
        <copy file="modules/luni-kernel/make/patternset.txt"
              tofile="${hy.hdk}/build/patternsets/luni-kernel.txt" />
        <copy file="modules/security-kernel/make/patternset.txt"
              tofile="${hy.hdk}/build/patternsets/security-kernel.txt" />
    </target>

    <target name="clean-kernel-patternsets">
        <delete dir="${hy.hdk}/build/patternsets" />
    </target>

    <!-- =================================
          target: compile
         ================================= -->
    <target name="compile" depends="copy-kernel-patternsets, prepare-depends"
            description="Compile the source">
        <mkdir dir="${build.output}" />

        <javac fork="yes" memoryMaximumSize="${hy.javac.maxmem}"
               destdir="${build.output}"
               source="${hy.javac.source}" target="${hy.javac.target}"
               debug="${hy.javac.debug}">
            <src path="modules/accessibility/src/main/java/" />
            <src path="modules/annotation/src/main/java/" />
            <src path="modules/applet/src/main/java" />
            <src path="modules/archive/src/main/java" />
            <src path="modules/auth/src/main/java/${hy.os}" />
            <src path="modules/auth/src/main/java/common" />
            <src path="modules/awt/src/main/java/${hy.os}" />
            <src path="modules/awt/src/main/java/common" />
            <src path="modules/beans/src/main/java" />
            <src path="modules/concurrent/src/main/java/" />
            <src path="modules/crypto/src/main/java" />
            <src path="modules/instrument/src/main/java" />
            <src path="modules/jndi/src/main/java" />
            <src path="modules/logging/src/main/java" />
            <src path="modules/lang-management/src/main/java/" />
            <src path="modules/luni-kernel/src/main/java" />
            <src path="modules/luni/src/main/java" />
            <src path="modules/math/src/main/java" />
            <src path="modules/misc/src/main/java" />
            <src path="modules/nio/src/main/java" />
            <src path="modules/nio_char/src/main/java" />
            <src path="modules/prefs/src/main/java" />
            <src path="modules/regex/src/main/java" />
            <src path="modules/${hy.rmi.module}/src/main/java" />
            <src path="modules/security-kernel/src/main/java" />
            <src path="modules/security/src/main/java/${hy.os}" />
            <src path="modules/security/src/main/java/common" />
            <src path="modules/sql/src/main/java" />
            <src path="modules/suncompat/src/main/java" />
            <src path="modules/swing/src/main/java/${hy.os}" />
            <src path="modules/swing/src/main/java/common" />
            <src path="modules/text/src/main/java" />
            <src path="modules/x-net/src/main/java/" />
            <classpath location="${build.output}" />
            <classpath>
                <fileset dir="${depends.jars}">
                    <include name="**/*.jar" />
                </fileset>
            </classpath>
        </javac>

        <mkdir dir="${hy.jdk}/jre/lib/boot" />

        <call-modules target="build" />

    </target>


    <!-- ================================= 
          target: layout              
         ================================= -->
    <target name="layout" 
        depends="compile" 
        description="Construct the correct directory structure for the class libs">
        <!-- Create the structure -->
        <mkdir dir="${hy.jdk}/jre/bin" />
        <mkdir dir="${hy.jdk}/jre/lib/boot" />
        <mkdir dir="${hy.jdk}/jre/lib/ext" />
        <mkdir dir="${hy.jdk}/jre/lib/security" />

        <!-- Copy across the boot dependency jars -->
        <copy todir="${hy.jdk}/jre/lib/boot" overwrite="yes"
              verbose="yes">
            <fileset dir="${depends.jars}">
                <patternset includes="*.jar" />
                <patternset includes="xerces_2.8.0/*.jar" />
                <patternset includes="xalan-j_2.7.0/*.jar" />
                <patternset includes="icu4j_3.4.4/*.jar" />
                <patternset includes="mx4j_3.0.1/*.jar" />
                <patternset includes="yoko/*.jar" />
            </fileset>
            <fileset dir="${depends.manifests}"/>
        </copy>

        <!-- Copy across the extension dependency jars -->
        <copy todir="${hy.jdk}/jre/lib/ext" overwrite="yes"
              verbose="yes" flatten="yes">
            <fileset file="${bcprov.jar}" />
        </copy>

        <!-- Copy across the jdk/lib dependency jars -->
        <copy todir="${hy.jdk}/lib" overwrite="yes"
              verbose="yes" flatten="yes">
            <fileset file="${ecj.jar}" />
        </copy>

        <!-- Copy across the support files -->
        <copy todir="${hy.jdk}/jre/lib/boot" overwrite="yes">
            <fileset dir="${depends.files}">
                <include name="bootclasspath.properties" />
            </fileset>
        </copy>
        <fixcrlf srcdir="${hy.jdk}/jre/lib/boot"
            includes="bootclasspath.properties" />

        <copy todir="${hy.jdk}/jre/lib/security" overwrite="yes">
             <fileset dir="${depends.files}">
                 <include name="java.policy" />
                 <include name="java.security" />
             </fileset>
         </copy>

    </target>


    <!-- ================================= 
          target: clean-layout              
         ================================= -->
    <target name="clean-layout">
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${hy.jdk}">
                <exclude name="jre/bin/default/**" />
            	<exclude name="jre/bin/**" />
                <exclude name="jre/lib/ext/**" />
            </fileset>
        </delete>
    </target>

    <target name="prepare-depends"
    	    description="Check for jars required to compile prefs">
    	
      <ant antfile="make/depends.xml" inheritall="false" target="check"/>

    </target>

</project>
