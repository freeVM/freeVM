<?xml version="1.0" encoding="UTF-8" ?>
<!--
    Copyright 2005-2006 The Apache Software Foundation or its licensors, as applicable.
  
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
  
       http://www.apache.org/licenses/LICENSE-2.0
  
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<project name="C UNIT TESTS">
    <target name="cunit.test" depends="init_component">
        <path id="unit.test.c.include">
            <pathelement location="${build.VM.home}/tests/unit/thread/utils" />
            <pathelement location="${build.semi.dir}/extra/apr/include" />
            <pathelement location="${build.semi.dir}/extra/apr/include/apr-1" />
            <pathelement location="${build.VM.home}/vmcore/include" />
        </path>
        <fileset id="unit.test.c.src" dir="${build.VM.home}/tests/unit/thread">
            <include name="*.c" />
            <exclude name="*performance*"/>
        </fileset>
        <!-- compiler to compile framework as well as the unit tests -->
        <compiler name="${build.cxx}" id="unit.test.c.compiler">
            <defineset define="APR_DECLARE_STATIC, _DEBUG, VM_STATS" />
            <defineset define="BUILDING_VM" />
            <select os="win">
                <defineset define="PLATFORM_NT, WIN32, _WINDOWS" />
                <defineset define="_WIN32_WINNT=0x0501" />
            </select>
            <select os="lnx">
                <defineset define="LINUX, GC_V4" />
                <defineset define="USE_DLL_JIT, PLATFORM_POSIX" />
                <defineset define="__SMP__, _REENTRANT" />
                <defineset define="LINUX_TLS_OPT, _IA32_" />
                <defineset define="_LARGEFILE64_SOURCE" />
                <compilerarg value="-Wall" />
                <compilerarg value="-fno-exceptions" />
                <compilerarg value="-g" />
                <compilerarg value="-O0" />
            </select>
            <select arch="ia32">
                <defineset define="_IA32_" />
            </select>
            <select arch="em64t">
                <defineset define="_EM64T_" />
                <defineset define="POINTER64" />
                <defineset define="LAZY_LOCK" />
            </select>
        </compiler>
        <!-- Compiling framework -->
        <echo message="## Compiling framework..." />
        <!-- a new property: cunit tests work dir -->
        <property name="unit.test.c.workdir"
                          value="${build.dir}/_cunit.tests" />
        <mkdir dir="${unit.test.c.workdir}/_obj" />
        <cc objdir="${unit.test.c.workdir}/_obj"
                    debug="true"
                    runtime="static"
                    multithreaded="true">
            <compiler refid="unit.test.c.compiler" />
            <fileset refid="unit.test.c.framework.src" />
            <fileset dir="${build.VM.home}/tests/unit/thread/utils">
                <include name="*.c" />
            </fileset>
            <includepath refid="unit.test.common.c.include" />
            <includepath refid="unit.test.c.include" />
        </cc>
        <!-- a list of all source files with unit tests -->
        <pathconvert pathsep=","
                             property="unit.test.c.files"
                             refid="unit.test.c.src" />
        <!-- operation system sensitive executive binary file extention.
                     simply said: "" or ".exe" ;) -->
        <condition property="extention" value=".exe">
            <isset property="if.win" />
        </condition>
        <property name="extention" value="" />
        <!-- replacing: 'xxx.c, yyy.c' => 'xxx yyy' -->
        <propertyregex override="yes"
                               property="unit.test.c.files"
                               input="${unit.test.c.files}"
                               regexp="\.c"
                               replace=""
                               defaultValue="${unit.test.c.files}" />
        <!-- Compiling unit tests -->
        <echo message="## Compiling C unit tests" />
        <cc objdir="${unit.test.c.workdir}/_obj"
                    debug="true"
                    runtime="static"
                    multithreaded="true" 
                    subsystem="console">
            <compiler refid="unit.test.c.compiler" />
            <fileset refid="unit.test.c.src" />
            <includepath refid="unit.test.common.c.include" />
            <includepath refid="unit.test.c.include" />
        </cc>
        <mkdir dir="${unit.test.c.workdir}/_bin" />

        <mkdir dir="${unit.test.c.workdir}/report" />
        <!-- set of properties which will be needed for test execution -->
        <property name="filename" value="--" />
        <property name="outputproperty" value="--" />
        <property name="resultproperty" value="--" />
        <for list="${unit.test.c.files}" param="file" delimiter=",">
            <sequential>
                <!-- make it possible to overwrite the property -->
                <var name="filename" unset="true" />
                <basename property="filename" file="@{file}" />
                <!-- Linking unit test -->
                <echo message="## Linking C unit test: ${filename}" />
                <cc name="${build.cxx}"
                            debug="true"
                            outfile="${unit.test.c.workdir}/_bin/${filename}"
                            outtype="executable" 
                            subsystem="console">
                    <linker name="${build.cxx}">
                        <fileset dir="${unit.test.c.workdir}/_obj">
                            <include name="${filename}.o*" />
                            <include name="thread_unit_test_main.o*" />
                            <include name="thread_unit_test_utils.o*" />
                            <include name="testframe.o*" />
                        </fileset>

                        <libset libs="hythr" dir="${build.semi.dir}/vm/hythr/_bin" />
                        <libset libs="encoder" dir="${build.semi.dir}/vm/encoder/_bin" />
                        <libset libs="aprutil-1" dir="${build.semi.dir}/extra/aprutil/_bin" />
                        <libset libs="port" dir="${build.semi.dir}/vm/port/_bin" />
                        <libset libs="log4cxx" dir="${build.semi.dir}/extra/log4cxx/_bin" />
                        <libset libs="hyzlib" dir="${external.dep.CLASSLIB}/deploy/jdk/jre/bin" />
                        <libset libs="jthread" dir="${build.semi.dir}/vm/jthread/_bin" />
                        <libset libs="harmonyvm" dir="${build.semi.dir}/vm/vmcore/_bin" />
                        <libset libs="icuuc" dir="${external.dep.CLASSLIB.libdir}" />
                        <select os="win">
                            <syslibset libs="advapi32, ws2_32, mswsock, user32, userenv, odbc32" />
                            <linkerarg value="/NODEFAULTLIB:libcmt.lib" />
                        </select>
                        <select os="lnx">
                            <syslibset type="shared" libs="stdc++, gcc_s, pthread, rt" />
                            <select arch="ia32">
<<<<<<< .mine
                    <libset type="shared" libs="icuuc"
=======
                                <libset type="shared" libs="icuuc"
>>>>>>> .r530955
                                    dir="${external.dep.CLASSLIB}/depends/libs/linux.x86" />
<<<<<<< .mine
                    <libset type="shared" libs="icudata"
=======
                                <libset type="shared" libs="icudata"
>>>>>>> .r530955
                                    dir="${external.dep.CLASSLIB}/depends/libs/linux.x86" />
                                </select>               
                            <select arch="em64t">
                                <libset type="shared" libs="icuuc"
                                    dir="${external.dep.CLASSLIB}/depends/libs/linux.x86_64" />
<<<<<<< .mine
                    <libset type="shared" libs="icudata"
=======
                                <libset type="shared" libs="icudata"
>>>>>>> .r530955
                                    dir="${external.dep.CLASSLIB}/depends/libs/linux.x86_64" />
                            </select>
                            <select arch="ipf">
                                <libset type="shared" libs="icuuc"
                                    dir="${external.dep.CLASSLIB}/depends/libs/linux.ia64" />
<<<<<<< .mine
                    <libset type="shared" libs="icudata"
=======
                                <libset type="shared" libs="icudata"
>>>>>>> .r530955
                                    dir="${external.dep.CLASSLIB}/depends/libs/linux.ia64" />
                            </select>
                        </select>
                    </linker>
                </cc>
            </sequential>
        </for>
        
        <delete file="${build.semi.dir}/cunit.test.failed" failonerror="false" />
            
        <for list="${unit.test.c.files}" param="file" delimiter=",">
            <sequential>
                <!-- make it possible to overwrite the property -->
                <var name="filename" unset="true" />
                <basename property="filename" file="@{file}" />
                <!-- Executing unit test -->
                <echo message="## Executing C unit test: ${filename}" />
                <var name="outputproperty" unset="true" />
                <var name="resultproperty" unset="true" />
                <exec dir="${unit.test.c.workdir}/_bin"
                              executable="${unit.test.c.workdir}/_bin/${filename}${extention}"
                              resultproperty="resultproperty"
                              outputproperty="outputproperty">
                    <arg value="-Dorg.apache.harmony.vm.vmdir=${build.deploy.dir}/jdk/jre/bin/default"/>
                    <arg value="-Djava.home=${build.deploy.dir}/jdk/jre"/>
                    <env key="JAVA_HOME" value="${build.deploy.dir}/jdk/jre" />
                    <select os="win">
                        <env key="Path" path="${build.deploy.dir}/jdk/jre/bin/:${build.deploy.dir}/jdk/jre/bin/default:${env.Path}" />
                    </select>
                    <select os="lnx">
                        <env key="LD_LIBRARY_PATH" path="${build.deploy.dir}/jdk/jre/bin/:${build.deploy.dir}/jdk/jre/bin/default" />
                    </select>
                </exec>
                <echo file="${unit.test.c.workdir}/report/${filename}.out"
                              message="${outputproperty}" />
                <echo message="${outputproperty}" />
                <if>
                    <not>
                        <equals arg1="${resultproperty}" arg2="0" />
                    </not>
                    <then>
                        <property name="test.failed" value="true" />
                        <echo message="## TEST FAILED" />
                        <echo file="${build.semi.dir}/cunit.test.failed" message="${filename} FAILED${line.separator}" append="true"/>

<echo file="${unit.test.c.workdir}/report/TEST-${filename}.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8" ?>
<testsuite errors="0" failures="1" name="@@@@@" tests="1" time="0.01">
<testcase classname="@@@@@" name="test" time="0.1"><error message="FAILED"/></testcase>
<system-out><![CDATA[@out]!]></system-out>
</testsuite>]]> 
</echo>

                    </then>
                    <else>
                        <echo message="## TEST PASSED" />
<echo file="${unit.test.c.workdir}/report/TEST-${filename}.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8" ?>
<testsuite errors="0" failures="0" name="@@@@@" tests="1" time="0.01">
<testcase classname="@@@@@" name="test" time="0.1"></testcase>
<system-out><![CDATA[@out]!]></system-out>
</testsuite>]]> 
</echo>
                    </else>
                </if>
                <replace file="${unit.test.c.workdir}/report/TEST-${filename}.xml" token="@@@@@" value="${filename}" /> 
                <!-- grab System.out to xml-file -->
                <if>
                    <isset property="outputproperty" />
                    <then>
                        <replace file="${unit.test.c.workdir}/report/TEST-${filename}.xml" token="@out]!" value="${outputproperty}]" />
                    </then>
                    <else>
                        <replace file="${unit.test.c.workdir}/report/TEST-${filename}.xml" token="@out]!" value="]" />
                    </else>
                </if>
            </sequential>
        </for>

        <property name="cunit.tests.report.dir" location="${unit.test.c.workdir}/report/html"/>
        <delete dir="${cunit.tests.report.dir}" />
        <mkdir dir="${cunit.tests.report.dir}" />
        <junitreport todir="${cunit.tests.report.dir}">
            <fileset dir="${unit.test.c.workdir}/report">
                <include name="*.xml"/>
            </fileset>
            <report format="frames" todir="${cunit.tests.report.dir}"/>
        </junitreport>

        <echo message="## Please find tests and results at ${build.dir}/_cunit.tests/" />
        <fail unless="run.all.tests" if="test.failed" message="## SOME TESTS FAILED"/>
    </target>
</project>
