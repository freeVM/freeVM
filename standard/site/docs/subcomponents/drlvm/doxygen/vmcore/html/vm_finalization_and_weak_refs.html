<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>VM Infrastructure: Design of finalization and weak references in VM.</title>
<link href="hydoxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<h1><a class="anchor" name="vm_finalization_and_weak_refs">Design of finalization and weak references in VM.</a></h1><dl class="author" compact><dt><b>Author:</b></dt><dd>Salikh Zakirov</dd></dl>
<dl class="version" compact><dt><b>Version:</b></dt><dd>written on 2005-05-31</dd></dl>
<h2><a class="anchor" name="vm_finalization_interactions">
Object Finalization</a></h2>
As described elsewhere, VM calls function gc_class_prepared() as a mandatory step of class preparation process, in order that GC have a chance to create its own class-specific structure (known as GCVT). During this call, GC can call <a class="el" href="vm_8h.html#cd27b4787353aada8f4c6d5481568810" title="TRUE if the class has a non-trivial finalizer.">class_is_finalizable()</a> to find out whether the instances of this class require finalizers to be run. The result is stored in GCVT for later use.<p>
At a later stage, when VM requests an object to be allocated by calling gc_alloc(), or gc_alloc_fast(), GC consults its GCVT to find out whether this class of objects needs to be finalized, and if so, adds the object reference in the finalizable queue, maintained by the GC. Allocation of finalizable objects is guarded from being handled by the inlined fast path by object size overloading hack (see allocation). This is needed due to the optimized nature of allocation fast path: fast path assumes that objects don't need any special handling, and we must ensure fast path fails for all object that do require special handling such as finalization.<p>
Later, when the garbage is being collected, GC walks over the finalizable object list and checks if the objects became eligible for finalization (i.e. not reachable otherwise). The GC side of the story is described in more detail in gc_finalization_and_weak_refs Object chosen for finalization are then "revived" and reported to the VM using <a class="el" href="vm__gc_8h.html#89b2daba8e2521dfc2a68bc3f0485349" title="GC should call this function when an object becomes "f-reachable, finalizable" The...">vm_finalize_object()</a>. Reviving is performed by marking the object in order to prevent it from being collected before the finalizer has been run. VM places all reported objects to its internal finalization queue and runs the finalizers in a separate thread at a later (unspecified) time. Note, that while running finalization in a dedicated thread is not directly required by the java specification, it is highly desirable in order to improve overall VM robustness, because finalizers may contain user code of arbitrary complexity, including synchronization with other user threads. Thus, running finalizers as a step of garbage collection process while other user threads are suspended will introduce a risk of deadlock and thus must be avoided.<p>
As finalization queue stores direct references to java heap, it is must be handled properly during heap compaction, by adding the locations of the pointers to the list of the slots updated during compaction.<h2><a class="anchor" name="vm_finalization_requirements">
Finalization requirements</a></h2>
The process described above places following requirements <ul>
<li>Finalizable objects must be allocated by calling into GC, that is not by the inlined fast path. </li>
<li><a class="el" href="vm__gc_8h.html#89b2daba8e2521dfc2a68bc3f0485349" title="GC should call this function when an object becomes "f-reachable, finalizable" The...">vm_finalize_object()</a> must defer running of finalizers to a later stage after the user java threads are resumed.</li>
</ul>
<h2><a class="anchor" name="vm_weak_refs">
Weak references</a></h2>
See the description of how weak references work in GC: gc_finalization_and_weak_refs <hr size="1">
<address style="text-align: center;">
  <small>
    <p>Genereated on Tue Mar 11 19:25:58 2008 by Doxygen.</p>
    <p>(c) Copyright 2005, 2008 The Apache Software Foundation or its licensors, as applicable. </p>
  </small>
</address>
</body>
</html>
